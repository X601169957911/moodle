{"version":3,"sources":["../src/search.js"],"names":["lunrIndex","pagesIndex","fetchJson","jsonFile","fetch","response","ok","Log","debug","status","json","jsondata","initLunr","then","ref","field","boost","forEach","p","add","initUI","searchInput","document","querySelector","selectors","searchinput","addEventListener","e","query","currentTarget","value","length","renderResults","search","map","result","filter","page","uri","results","dropdownMenu","dropdownmenu","innerHTML","baseUrl","M","cfg","wwwroot","slice","link","createElement","chapter","split","appendChild","createTextNode","title","classList","href","listItem","init"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Interface to the Lunr search engines.\n *\n * @module     tool_componentlibrary/search\n * @package    tool_componentlibrary\n * @copyright  2021 Bas Brands <bas@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport LunrJs from 'tool_componentlibrary/lunr';\nimport selectors from 'tool_componentlibrary/selectors';\nimport Log from 'core/log';\n\nlet lunrIndex = null;\nlet pagesIndex = null;\n\n/**\n * Get the jsonFile that is generated when the component library is build\n * @param {String} jsonFile the URL to the json file.\n * @retrun {Object}\n */\nconst fetchJson = async(jsonFile) => {\n    const response = await fetch(jsonFile);\n\n    if (!response.ok) {\n        Log.debug(`Error getting Hugo index file: ${response.status}`);\n    }\n\n    const jsondata = await response.json();\n    return jsondata;\n};\n\n/**\n * Initiate lunr on the data in the jsonFile\n * and add the jsondata to the pagesIndex\n * @param {String} jsonFile the URL to the json file.\n */\nconst initLunr = (jsonFile) => {\n    fetchJson(jsonFile).then((jsondata) => {\n        pagesIndex = jsondata;\n        // Using an arrow function here will break lunr on compile.\n        lunrIndex = LunrJs(function() {\n            this.ref('uri');\n            this.field('title', { boost: 10 });\n            this.field('content');\n            this.field('tags', { boost: 5 });\n            jsondata.forEach(p => {\n              this.add(p);\n            });\n        });\n    });\n};\n\n\n/**\n * Setup the eventlistener to listen on user input on the search field.\n */\nconst initUI = () => {\n    const searchInput = document.querySelector(selectors.searchinput);\n    searchInput.addEventListener('keyup', (e) => {\n        let query = e.currentTarget.value;\n        if (query.length < 2) {\n            return;\n        }\n        renderResults(search(query));\n    });\n};\n\n/**\n * Trigger a search in lunr and transform the result\n *\n * @param  {String} query\n * @return {Array}  results\n */\nconst search = (query) => {\n    // Find the item in our index corresponding to the lunr one to have more info\n    // Lunr result:\n    //  {ref: \"/section/page1\", score: 0.2725657778206127}\n    // Our result:\n    //  {title:\"Page1\", href:\"/section/page1\", ...}\n    return lunrIndex.search(query).map((result) => {\n        return pagesIndex.filter((page) => {\n            return page.uri === result.ref;\n        })[0];\n    });\n};\n\n/**\n * Display the 10 first results\n *\n * @param  {Array} results to display\n */\nconst renderResults = (results) => {\n    if (!results.length) {\n        return;\n    }\n\n    const dropdownMenu = document.querySelector(selectors.dropdownmenu);\n    // Clear out the results.\n    dropdownMenu.innerHTML = '';\n\n    const baseUrl = M.cfg.wwwroot + '/admin/tool/componentlibrary/docspage.php';\n\n    // Only show the ten first results\n    results.slice(0, 10).forEach(function(result) {\n        const link = document.createElement(\"a\");\n        const chapter = result.uri.split('/')[1];\n        link.appendChild(document.createTextNode(`${chapter} > ${result.title}`));\n        link.classList.add('dropdown-item');\n        link.href = baseUrl + result.uri;\n\n        const listItem = document.createElement(\"li\");\n        listItem.appendChild(link);\n\n        dropdownMenu.appendChild(listItem);\n    });\n\n    dropdownMenu.classList.add('show');\n};\n\nexport const init = (jsonFile) => {\n    initLunr(jsonFile);\n    initUI();\n};\n"],"file":"search.min.js"}