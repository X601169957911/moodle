define ("core/image_editable",["exports","core/ajax","core/croppie","core/str","core/templates","core/notification","core/utils"],function(a,b,c,d,e,f,g){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.init=void 0;b=h(b);c=h(c);e=h(e);f=h(f);function h(a){return a&&a.__esModule?a:{default:a}}var i={actions:{confirm:"[data-action=\"confirm\"]",cancel:"[data-action=\"cancel\"]",cropimage:"[data-action=\"cropimage\"]",uploadimage:"[data-action=\"uploadimage\"]",deleteimage:"[data-action=\"deleteimage\"]"},regions:{imagehandler:"[data-region=\"imagehandler\"]",imagecontrols:"[data-region=\"imagecontrols\"]",alert:".alert",zoomslider:".cr-slider",editactions:"[data-region=\"editactions\"]",confirmactions:"[data-region=\"confirmactions\"]",spinner:"[data-region=\"spinner\"]",hiddenFormField:"[data-region=\"hiddenformfield\"]"},classes:{hidden:"d-none",saving:"saving",deleting:"deleting",disabled:"disabled",enabled:"js-enabled"}},j=function(a,b){return e.default.render("core/notification",{message:b,closebutton:!0,iswarning:!0}).then(function(b,c){e.default.prependNodeContents(a,b,c)})},k=function(a){var b=a.querySelector(i.regions.alert);if(b){b.remove()}},l=function(a,b){var c=a.querySelector(i.regions.spinner);if(b){c.classList.remove(i.classes.hidden)}else{c.classList.add(i.classes.hidden)}},m=function(a,b){var c=a.querySelector(i.actions.deleteimage);if(b){c.classList.add(i.classes.enabled);c.setAttribute("tabindex",0)}else{c.classList.remove(i.classes.enabled);c.setAttribute("tabindex",-1)}},n=function(a){var b=a.getAttribute("data-currentimage"),c=a.querySelector(i.actions.cropimage),d=a.querySelector(i.regions.confirmactions),e=a.querySelector(i.regions.editactions);if(b){c.classList.remove(i.classes.hidden);m(a,!0)}else{c.classList.add(i.classes.hidden);m(a,!1)}d.classList.add(i.classes.hidden);e.classList.remove(i.classes.hidden);k(a)},o=function(a){var c=b.default.call([{methodname:"core_imageeditable_update_image",args:a}])[0].fail(f.default.exception);return c},p=function(a,b){a.style.backgroundImage="url(\""+b+"\")"},q=function(a,b,c){var d=a.querySelector(i.regions.confirmactions),e=a.querySelector(i.regions.editactions),f=a.querySelector(i.actions.confirm),g=f.cloneNode(!0);f.parentNode.replaceChild(g,f);b.done(function(a){g.innerHTML=a;d.classList.remove(i.classes.hidden);e.classList.add(i.classes.hidden);g.addEventListener("click",function(a){c();a.preventDefault()})});m(a,!1)},r=function(a,b){var c=a.querySelector(i.actions.cancel),d=c.cloneNode(!0);c.parentNode.replaceChild(d,c);d.addEventListener("click",function(a){b();a.preventDefault()})},s=function(a){var b=a.querySelector(i.regions.imagehandler),e=a.getAttribute("data-currentimage"),g=a.getAttribute("data-size"),h=new c.default(b,{enableExif:!0,viewport:{width:90*(g/100),height:90*(g/100),type:"square"}});h.bind({url:e});p(b,"");var k=a.querySelector(i.regions.zoomslider);k.classList.add("form-control-range");k.setAttribute("step",.01);if("rounded"===a.getAttribute("data-rounded")){a.querySelector(".cr-viewport").classList.add("cr-vp-circle")}q(a,(0,d.get_string)("cropimage","repository"),function(){h.result("base64").then(function(c){var d={imagedata:c.split("base64,")[1],imagefilename:"cropped.png",cropped:1,component:a.getAttribute("data-component"),filearea:a.getAttribute("data-filearea"),contextid:a.getAttribute("data-contextid"),draftitemid:a.getAttribute("data-draftitemid")};l(a,!0);o({params:d}).then(function(d){if(d.success){p(b,c);h.destroy()}if(d.warning){j(b,d.warning,"warning")}l(a,!1);n(a)}).catch(f.default.exception)}).catch(f.default.exception)});r(a,function(){h.destroy();p(b,e);n(a)})},t=function(a,b,c){var e=a.querySelector(i.regions.imagehandler),h=a.querySelector(i.regions.hiddenFormField),k=c.target.files[0];if(!k.type.match("image.*")){return}var m=a.getAttribute("data-currentimage");if(""===m){m=a.getAttribute("data-defaultimage")}var s=new FileReader;s.onload=function(){var c=s.result;if(k.size>b){var u={size:(0,g.humanFileSize)(b),file:k.name};(0,d.get_string)("maxbytesfile","error",u).done(function(a){j(e,a)});return}var i=document.createElement("img");i.setAttribute("src",c);i.addEventListener("load",function(){if(512>i.naturalWidth){(0,d.get_string)("resolutionlow","error").done(function(a){j(e,a)})}});p(e,c);var t={imagefilename:k.name,imagedata:c.split("base64,")[1],cropped:0,component:a.getAttribute("data-component"),filearea:a.getAttribute("data-filearea"),contextid:a.getAttribute("data-contextid"),draftitemid:a.getAttribute("data-draftitemid")};q(a,(0,d.get_string)("save","admin"),function(){l(a,!0);o({params:t}).then(function(b){if(b.success){a.setAttribute("data-currentimage",b.fileurl);m=b.fileurl}if(b.warning){j(e,b.warning,"warning")}if(h){h.value=t.draftitemid}l(a,!1);n(a)}).catch(f.default.exception)});r(a,function(){p(e,m);n(a)})};s.readAsDataURL(k)},u=function(a){var b=a.querySelector(i.actions.deleteimage),c=a.querySelector(i.regions.hiddenFormField);if(!b.classList.contains(i.classes.enabled)){return""}var e=a.getAttribute("data-defaultimage"),g=a.querySelector(i.regions.imagehandler),h={imagedata:"",imagefilename:"",cropped:0,component:a.getAttribute("data-component"),filearea:a.getAttribute("data-filearea"),contextid:a.getAttribute("data-contextid"),draftitemid:a.getAttribute("data-draftitemid"),delete:1};q(a,(0,d.get_string)("delete","moodle"),function(){l(a,!0);o({params:h}).then(function(b){if(b.success){p(g,e);a.setAttribute("data-currentimage","")}if(c){c.value=-1}l(a,!1);n(a);return""}).catch(f.default.exception)});r(a,function(){n(a)});return""};a.init=function init(a,b){var c=a.querySelector(i.actions.cropimage),d=a.querySelector(i.actions.uploadimage),e=a.querySelector(i.actions.deleteimage),f=a.querySelector(i.regions.imagecontrols);c.addEventListener("click",function(b){s(a);b.preventDefault()});d.addEventListener("change",function(c){t(a,b,c);c.preventDefault()});e.addEventListener("click",function(b){u(a);b.preventDefault()});n(a);f.classList.add("js-enabled")}});
//# sourceMappingURL=image_editable.min.js.map
